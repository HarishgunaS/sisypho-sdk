<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Extension Navigation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 3px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>MCP Extension Navigation Test</h1>
    
    <div class="test-section">
        <h2>Connection Status</h2>
        <div id="connection-status" class="status info">Checking connection...</div>
        <button onclick="checkConnection()">Check Connection</button>
        <button onclick="testInteraction()">Test Interaction</button>
    </div>

    <div class="test-section">
        <h2>Navigation Tests</h2>
        <p>These tests will help verify that the MCP connection remains robust during page navigation:</p>
        <button onclick="testPageReload()">Test Page Reload</button>
        <button onclick="testNewPage()">Test New Page Navigation</button>
        <button onclick="testSamePageNavigation()">Test Same Page Navigation</button>
    </div>

    <div class="test-section">
        <h2>Interaction Tests</h2>
        <p>Test various user interactions:</p>
        <button onclick="testClick()">Test Click</button>
        <input type="text" id="test-input" placeholder="Type here to test input" style="margin: 5px;">
        <form id="test-form" onsubmit="testSubmit(event)">
            <input type="text" placeholder="Form input" style="margin: 5px;">
            <button type="submit">Test Form Submit</button>
        </form>
    </div>

    <div class="test-section">
        <h2>MCP Tool Tests</h2>
        <button onclick="testRetrieveQueue()">Test Retrieve Interaction Queue</button>
        <button onclick="testQueueSize()">Test Queue Size</button>
        <div id="mcp-results" class="status info">MCP tool results will appear here...</div>
    </div>

    <script>
        // Check if MCP extension is loaded
        function checkMCPExtension() {
            if (window.McpExtensionClient) {
                return true;
            }
            return false;
        }

        // Update connection status
        function updateConnectionStatus(message, type = 'info') {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Check connection status
        function checkConnection() {
            if (!checkMCPExtension()) {
                updateConnectionStatus('MCP Extension not loaded', 'error');
                return;
            }

            const client = window.McpExtensionClient;
            if (client._connected) {
                updateConnectionStatus('MCP Extension connected and ready', 'success');
            } else {
                updateConnectionStatus('MCP Extension disconnected, attempting to reconnect...', 'error');
                client._checkConnectionStatus();
            }
        }

        // Test user interaction
        function testInteraction() {
            updateConnectionStatus('Testing interaction...', 'info');
            // This will trigger the click event listener in the content script
            setTimeout(() => {
                updateConnectionStatus('Interaction test completed', 'success');
            }, 1000);
        }

        // Test page reload
        function testPageReload() {
            updateConnectionStatus('Reloading page in 3 seconds...', 'info');
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }

        // Test navigation to new page
        function testNewPage() {
            updateConnectionStatus('Navigating to new page in 3 seconds...', 'info');
            setTimeout(() => {
                window.location.href = 'https://example.com';
            }, 3000);
        }

        // Test same page navigation (hash change)
        function testSamePageNavigation() {
            updateConnectionStatus('Testing same page navigation...', 'info');
            window.location.hash = 'test-' + Date.now();
            setTimeout(() => {
                updateConnectionStatus('Same page navigation test completed', 'success');
            }, 1000);
        }

        // Test click
        function testClick() {
            updateConnectionStatus('Click test completed', 'success');
        }

        // Test form submit
        function testSubmit(event) {
            event.preventDefault();
            updateConnectionStatus('Form submit test completed', 'success');
        }

        // Test MCP tool - retrieve interaction queue
        function testRetrieveQueue() {
            if (!checkMCPExtension()) {
                updateConnectionStatus('MCP Extension not loaded', 'error');
                return;
            }

            const resultsDiv = document.getElementById('mcp-results');
            resultsDiv.textContent = 'Testing retrieve_write_interaction_queue...';
            resultsDiv.className = 'status info';

            // Call the MCP tool
            if (window.retrieve_write_interaction_queue) {
                try {
                    const result = window.retrieve_write_interaction_queue();
                    resultsDiv.textContent = `Retrieved ${result.count} interactions: ${JSON.stringify(result, null, 2)}`;
                    resultsDiv.className = 'status success';
                } catch (error) {
                    resultsDiv.textContent = `Error: ${error.message}`;
                    resultsDiv.className = 'status error';
                }
            } else {
                resultsDiv.textContent = 'retrieve_write_interaction_queue tool not available';
                resultsDiv.className = 'status error';
            }
        }

        // Test MCP tool - get queue size
        function testQueueSize() {
            if (!checkMCPExtension()) {
                updateConnectionStatus('MCP Extension not loaded', 'error');
                return;
            }

            const resultsDiv = document.getElementById('mcp-results');
            resultsDiv.textContent = 'Testing getInteractionQueueSize...';
            resultsDiv.className = 'status info';

            // Call the MCP tool
            if (window.getInteractionQueueSize) {
                try {
                    const result = window.getInteractionQueueSize();
                    resultsDiv.textContent = `Queue size: ${result.size}`;
                    resultsDiv.className = 'status success';
                } catch (error) {
                    resultsDiv.textContent = `Error: ${error.message}`;
                    resultsDiv.className = 'status error';
                }
            } else {
                resultsDiv.textContent = 'getInteractionQueueSize tool not available';
                resultsDiv.className = 'status error';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Check MCP extension status after a short delay
            setTimeout(() => {
                checkConnection();
            }, 2000);

            // Set up periodic connection checks
            setInterval(() => {
                if (checkMCPExtension()) {
                    const client = window.McpExtensionClient;
                    if (!client._connected) {
                        updateConnectionStatus('Connection lost, attempting to reconnect...', 'error');
                        client._checkConnectionStatus();
                    }
                }
            }, 10000);
        });
    </script>
</body>
</html> 